datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

type OsImage {
  url         String
  source      String?
  description String?
}

model Plugin {
  id                        String         @id @default(auto()) @map("_id") @db.ObjectId
  pluginId                  String         @unique
  name                      String?
  author                    String?
  description               String?
  repo                      String
  createdAt                 Int
  nextUpdateAt              Int?
  lastCommitAt              Int?
  stargazers                Int?
  subscribers               Int?
  forks                     Int?
  latestRelease             String?
  latestReleaseDesc         String?
  latestReleaseAt           Int?
  totalDownloads            Int?
  totalIssues               Int?
  closedIssues              Int?
  openIssues                Int?
  totalPR                   Int?
  openPR                    Int?
  closedPR                  Int?
  mergedPR                  Int?
  commitCountInLastYear     Int?
  zScoreTrending            Float?
  maScoreTrending           Float?
  osDescription             String?
  osCategory                String?
  osTags                    String?
  osImages                  OsImage[]
  score                     Float?
  scoreReason               String?
  healthScore               Float?
  popularityScore           Float?
  controlIsArchived         Boolean?
  website                   String?
  languages                 String?
  requirements              String[]
}

model ReleaseDownloads {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  pluginId        String         @unique
  timestamp       Int
  deltaDownload   Int
}

model DeltaDownloads {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  pluginId         String         @unique
  timestamp        Int
  deltaDownloads    Int
  totalDownloads   Int
  @@unique([pluginId, timestamp])
}

model PluginTags {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  tag              String
  pluginId         String
}

model ScoreBounds {
  id                String         @id @default(auto()) @map("_id") @db.ObjectId
  metric            String         @unique
  min               Float
  max               Float
  updatedAt         Int
}

model DataConsumptionHorizon {
  id                  String         @id @default(auto()) @map("_id") @db.ObjectId
  name                String         @unique
  consumptionHorizon  String
  type                String
  updatedAt           Int
}

// Tracks pull request derived prospective (beta) plugins / themes
model PullRequestEntry {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  prNumber         Int      @unique
  prStatus         String   // open | closed | merged (GitHub PR state)
  status           String   @default("in-review") // plugin/theme promotion lifecycle: in-review | promoted | rejected
  prLabels         String?  // comma separated label names
  type             String?  // plugin | theme
  operation        String?  // add | update | delete
  repo             String?  // <author>/<repo>
  pluginId         String?
  name             String?
  version          String?
  description      String?
  author           String?
  createdAt        Int      // first seen (epoch ms)
  lastUpdatedAt    Int      // last processed (any step)
  lastClassifiedAt Int?     // last time classification step ran
  lastEnrichedAt   Int?     // last time enrichment step ran
  needManualReview Boolean  @default(false)
  manualReviewReason String? // why manual review was requested (missing fields, errors, etc.)

  @@index([prStatus])
  @@index([needManualReview])
  @@index([lastClassifiedAt])
  @@index([lastEnrichedAt])
}

model Theme {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  repo       String
  isDark     Boolean?
  isLight    Boolean?
  screenshot String?
  isLegacy   Boolean?
  createdAt  Int
  deletedAt  Int?

  @@index([repo])
  @@index([name])
  @@index([deletedAt])
}

model User {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  email         String   @unique
  googleId      String   @unique
  name          String?
  avatar        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  reviews       Review[] // Relation to reviews
  
  @@map("users")
}

enum EntityType {
  PLUGIN
  THEME
}

model Review {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  entityId    String   // The plugin or theme identifier
  entityType  EntityType
  entityVer   String?
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id])
  rating      Int      // 1-5 rating
  reviewText  String?  @db.String // Max 2000 chars (enforced in DTO)
  
  flagged     Boolean  @default(false)
  needsModeration Boolean @default(false)
  approvedAt    DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, entityId, entityType])
  @@index([entityId]) // Fast lookup by entity
  @@index([userId])   // Fast lookup by user
  @@map("reviews")
}

model PluginStats {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  entityId        String   @unique
  entityType      EntityType
  totalReviews    Int      @default(0)
  averageRating   Float    @default(0)
  ratingCount1    Int      @default(0)
  ratingCount2    Int      @default(0)
  ratingCount3    Int      @default(0)
  ratingCount4    Int      @default(0)
  ratingCount5    Int      @default(0)
  updatedAt       DateTime @updatedAt
  
  @@map("plugin_stats")
}
